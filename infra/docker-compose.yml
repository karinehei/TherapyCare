# TherapyCare local dev stack
# Run from project root: docker compose -f infra/docker-compose.yml up
# Optional: create infra/.env for overrides
# Access: http://localhost:8080 (nginx) or http://localhost:5173 (frontend direct), http://localhost:8000 (backend direct)

services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-therapycare}
      POSTGRES_USER: ${POSTGRES_USER:-therapycare}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-therapycare}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-therapycare}"]
      interval: 5s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    # On Windows bind mounts, .sh files can end up with CRLF, which breaks execution in Linux containers.
    # Normalize line endings at runtime before starting the real entrypoint.
    entrypoint: ["sh", "-c", "sed -i \"s/\\r$//\" /app/entrypoint.sh || true; chmod +x /app/entrypoint.sh || true; exec /app/entrypoint.sh"]
    environment:
      SECRET_KEY: ${SECRET_KEY:-dev-secret-key-change-in-production}
      DEBUG: "true"
      DJANGO_SETTINGS_MODULE: config.settings.dev
      POSTGRES_DB: ${POSTGRES_DB:-therapycare}
      POSTGRES_USER: ${POSTGRES_USER:-therapycare}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-therapycare}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      ALLOWED_HOSTS: localhost,127.0.0.1,backend
      CORS_ALLOWED_ORIGINS: http://localhost:5173,http://localhost:3000,http://localhost:8080,http://127.0.0.1:8080
      RUN_MODE: ${RUN_MODE:-runserver}
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ../backend:/app

  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    environment:
      VITE_MODE: ${VITE_MODE:-dev}
      # Vite dev-server proxy target (inside compose network)
      VITE_PROXY_TARGET: http://backend:8000
    ports:
      - "5173:5173"
    volumes:
      - ../frontend:/app
      - /app/node_modules
    # Vite dev on 5173; build mode: build + preview on 5173 so nginx always proxies to same port
    command: ["sh", "-c", "npm install && if [ \"$VITE_MODE\" = build ]; then npm run build && exec npm run preview -- --host 0.0.0.0 --port 5173; else exec npm run dev -- --host 0.0.0.0 --port 5173; fi"]

  nginx:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
      - frontend

volumes:
  postgres_data:
